steps:
  - id: 'Receive files from bucket'
    name: 'gcr.io/cloud-builders/gsutil'
    args:
      - 'cp'
      - '-r'
      - 'gs://${PROJECT_ID}_cloudbuild/deps/root/.ssh'
      - '/root/'
    volumes:
      - name: 'ssh'
        path: /root/.ssh
  - id: 'Decrypt the file containing the key'
    name: 'gcr.io/cloud-builders/gcloud'
    args:
      - kms
      - decrypt
      - --ciphertext-file=/root/.ssh/id_rsa.enc
      - --plaintext-file=/root/.ssh/id_rsa
      - --location=global
      - --keyring=projects/dgp-admin-tools/locations/global/keyRings/cloubbuild-github-keyring
      - --key=projects/dgp-admin-tools/locations/global/keyRings/cloudbuild-github-keyring/cryptoKeys/github-key
    volumes:
      - name: 'ssh'
        path: /root/.ssh
  - id: 'Set up git with key and domain'
    name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        chmod 600 /root/.ssh/id_rsa
        cat <<EOF >/root/.ssh/config
        Hostname github.com
        IdentityFile /root/.ssh/id_rsa
        EOF
    volumes:
      - name: 'ssh'
        path: /root/.ssh
  - id: 'Pull code from repository'
    name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        git clone -b $BRANCH_NAME git@github.com:dawn-foods-digital/$REPO_NAME
        cd $REPO_NAME
        git submodule init
        git submodule update
        echo $(date +"%Y.%m.%d").$(git rev-list --count $BRANCH_NAME).$(git log --oneline -1 | awk -F/ '{ if ($2=="") print "master"; else print $2;}') > /workspace/IMAGE_VERSION
        cat /workspace/IMAGE_VERSION
    volumes:
      - name: 'ssh'
        path: /root/.ssh
  - id: 'Build image'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -f cloudbuild/Dockerfile -t gcr.io/${PROJECT_ID}/b2b-bff:$(cat /workspace/IMAGE_VERSION) .
  - id: 'Push image'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker push gcr.io/${PROJECT_ID}/b2b-bff:$(cat /workspace/IMAGE_VERSION)
  - id: 'Deploy image'
    name: 'gcr.io/${PROJECT_ID}/kustomize'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud container clusters get-credentials ${_CLOUDSDK_CONTAINER_CLUSTER} --zone ${_CLOUDSDK_COMPUTE_ZONE} --project ${_PROJECT_ID}
        cd k8s/overlays/${_ENV_NAMESPACE}
        kustomize edit set image gcr.io/project_id_stub/subscriptions=gcr.io/${PROJECT_ID}/subscriptions:$(cat /workspace/IMAGE_VERSION)
        kustomize edit add annotation kubernetes.io/change-cause:"deploying $(cat /workspace/IMAGE_VERSION)"
        kustomize build | kubectl -n ${_ENV_NAMESPACE} apply -f -
        kubectl -n ${_ENV_NAMESPACE} rollout status deployment subscriptions
options:
  machineType: 'N1_HIGHCPU_8'
